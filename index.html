<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mess Menu</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2196f3">
  <style>
    :root{--bg:#0b1020;--card:#141a2f;--text:#eaf2ff;--muted:#9bb0d3;--accent:#2196f3;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:flex-start}
    .container{width:100%;max-width:720px;padding:16px}
    .card{background:linear-gradient(180deg,#141a2f,#10162a);border:1px solid #223052; box-shadow:0 10px 30px rgba(0,0,0,.45); border-radius:20px; padding:20px}
    h1{font-size:1.4rem;margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;margin-bottom:14px;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:none;background:var(--accent);color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.outline{background:transparent;border:1px solid #29406c;color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr; gap:12px}
    .section-title{margin:12px 0 6px;font-size:1.05rem;color:#cfe1ff}
    .meal-card{background:#0d1429;border:1px solid #253659;border-radius:16px;padding:14px}
    .meal-card h3{margin:0 0 6px;font-size:1.1rem}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0e1428;border:1px solid #213052;color:#b9c7e8;padding:6px 10px;border-radius:999px;font-size:.85rem}
    ul{padding-left:18px;line-height:1.6;margin:6px 0 0}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .field{display:flex;gap:8px}
    input[type="email"], input[type="text"]{flex:1;min-width:240px;padding:10px;border:1px solid #29406c;background:#0c1326;color:var(--text);border-radius:10px}
    label{font-size:.9rem;color:#b9c7e8;margin-bottom:6px;display:block}
    .error{color:#ff9191;margin-top:6px;font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row">
        <h1>üçΩÔ∏è Mess Menu</h1>
        <button id="installBtn" class="btn" hidden>Install</button>
      </div>

      <!-- AUTH GATE -->
      <div id="authGate">
        <p class="muted">Please verify your email to continue.</p>
        <label for="email">IIM Mumbai Email</label>
        <div class="field">
          <input id="email" type="email" placeholder="you@iimmumbai.ac.in" autocomplete="email" inputmode="email">
          <button id="sendOtpBtn" class="btn outline">Send OTP</button>
        </div>
        <div id="emailError" class="error hidden"></div>
        <div id="otpArea" class="hidden" style="margin-top:12px">
          <label for="otp">Enter OTP</label>
          <div class="field">
            <input id="otp" type="text" placeholder="6-digit code" inputmode="numeric" maxlength="6">
            <button id="verifyBtn" class="btn">Verify</button>
          </div>
          <div id="otpError" class="error hidden"></div>
          <p class="muted" id="otpHint" style="margin:6px 0 0"></p>
        </div>
      </div>

      <!-- APP CONTENT -->
      <div id="app" class="hidden">
        <div id="currentSection" class="hidden">
          <div class="section-title">Currently Serving</div>
          <div id="currentCard" class="meal-card"></div>
        </div>

        <div id="nextSection">
          <div class="section-title">Next Meal</div>
          <div id="nextCard" class="meal-card"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =====================
   CONFIG
===================== */
const CONFIG = {
  emailDomain: "@iimmumbai.ac.in",
  otpExpireMinutes: 10,
  sessionDays: 30,
  emailProvider: "webhook", // "webhook" or "gmail_api"
  webhookUrl: "", // e.g. "https://script.google.com/macros/s/XXXXX/exec"
  gmail: {
    clientId: "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
  }
};

/* =====================
   PWA Install
===================== */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.hidden = false;
  btn.addEventListener('click', async ()=>{
    btn.hidden = true;
    if(deferredPrompt){
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    }
  }, { once: true });
});
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>navigator.serviceWorker.register('service-worker.js'));
}

/* =====================
   MENU LOGIC
===================== */
const MEAL_ORDER = ["breakfast","lunch","snacks","dinner"];
const DAY_ORDER = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
let MENU = null;

function parseHM(s){const [h,m]=s.split(':').map(Number);return h*60+m;}
function nowMinutes(){
  const d = new Date();
  return d.getHours()*60 + d.getMinutes();
}
function mealWindow(mealKey){
  const m = MENU.meals[mealKey];
  return [parseHM(m.start), parseHM(m.end)];
}
function whichCurrent(idxDay){
  const t = nowMinutes();
  for(const key of MEAL_ORDER){
    const [s,e] = mealWindow(key);
    if(t >= s && t <= e) return {dayIndex: idxDay, meal: key};
  }
  return null;
}
function whichNext(idxDay){
  const t = nowMinutes();
  for(const key of MEAL_ORDER){
    const [s,_] = mealWindow(key);
    if(t < s) return {dayIndex: idxDay, meal: key};
  }
  return {dayIndex: (idxDay+1)%7, meal: MEAL_ORDER[0]};
}
function titleCase(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }

function renderMealCard(containerId, dayIndex, meal){
  const dayKey = DAY_ORDER[dayIndex];
  const items = (MENU.days[dayKey]?.[meal] || []);
  const win = MENU.meals[meal];
  const html = `
    <h3>${titleCase(meal)} <span class="pill">${win.start} ‚Äì ${win.end}</span></h3>
    ${items.length ? `<ul>${items.map(i=>`<li>${i}</li>`).join('')}</ul>` : `<p class="muted">No items listed in menu.json</p>`}
  `;
  document.getElementById(containerId).innerHTML = html;
}

function refreshView(){
  const today = new Date().getDay();
  const cur = whichCurrent(today);
  const nxt = whichNext(today);

  const currentSection = document.getElementById('currentSection');
  if(cur){
    currentSection.classList.remove('hidden');
    renderMealCard('currentCard', cur.dayIndex, cur.meal);
  } else {
    currentSection.classList.add('hidden');
  }
  renderMealCard('nextCard', nxt.dayIndex, nxt.meal);
}

async function loadMenu(){
  const resp = await fetch('menu.json?v='+Date.now());
  MENU = await resp.json();
  refreshView();
}

/* =====================
   AUTH GATE (Email + OTP)
===================== */
const authKey = 'mm_auth_v1';
function setSession(email){
  const exp = Date.now() + CONFIG.sessionDays*24*60*60*1000;
  localStorage.setItem(authKey, JSON.stringify({email, exp}));
}
function getSession(){
  try { return JSON.parse(localStorage.getItem(authKey) || "null"); } catch(e){ return null; }
}
function hasValidSession(){
  const s = getSession();
  return s && s.exp && Date.now() < s.exp && typeof s.email === 'string' && s.email.endsWith(CONFIG.emailDomain);
}

let OTP_VALUE = null;
let OTP_EXPIRES = 0;
let OTP_EMAIL = "";

function genOtp(){ return Math.floor(100000 + Math.random()*900000).toString(); }

async function sendOtpEmail(toEmail, otp){
  const subject = "Your Mess Menu verification code";
  const html = `
    <div style="font-family:Arial,Helvetica,sans-serif;font-size:16px;line-height:1.5">
      <p>Hi,</p>
      <p>Your verification code is:</p>
      <p style="font-size:24px;font-weight:700;letter-spacing:2px">${otp}</p>
      <p>This code expires in ${CONFIG.otpExpireMinutes} minutes.</p>
    </div>`;

  if(CONFIG.emailProvider === "webhook"){
    if(!CONFIG.webhookUrl) throw new Error("EMAIL_WEBHOOK_URL is not set.");
    const res = await fetch(CONFIG.webhookUrl, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ to: toEmail, subject, html })
    });
    if(!res.ok) throw new Error("Webhook email failed: " + res.status);
  } else if(CONFIG.emailProvider === "gmail_api"){
    throw new Error("Gmail API flow not implemented. See README for setup.");
  } else {
    throw new Error("Unknown emailProvider");
  }
}

function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }
function setError(id, msg){ const el=document.getElementById(id); if(msg){el.textContent=msg; el.classList.remove('hidden');} else {el.classList.add('hidden');} }

function initAuth(){
  if(hasValidSession()){
    hide('authGate'); show('app'); loadMenu(); return;
  }
  const emailInp = document.getElementById('email');
  const sendBtn = document.getElementById('sendOtpBtn');
  const otpArea = document.getElementById('otpArea');
  const otpInp = document.getElementById('otp');
  const verifyBtn = document.getElementById('verifyBtn');
  const otpHint = document.getElementById('otpHint');

  sendBtn.addEventListener('click', async ()=>{
    const email = (emailInp.value || "").trim().toLowerCase();
    if(!email.endsWith(CONFIG.emailDomain)){
      setError('emailError', `Please use your ${CONFIG.emailDomain} email.`);
      return;
    }
    setError('emailError', "");
    OTP_VALUE = genOtp();
    OTP_EXPIRES = Date.now() + CONFIG.otpExpireMinutes*60*1000;
    OTP_EMAIL = email;
    otpHint.textContent = `Code sent to ${email}.`;
    show('otpArea');
    try{
      await sendOtpEmail(email, OTP_VALUE);
    }catch(err){
      setError('emailError', "Failed to send OTP: " + err.message);
    }
  });

  verifyBtn.addEventListener('click', ()=>{
    const code = (otpInp.value || "").trim();
    if(!OTP_VALUE){ setError('otpError',"Please request an OTP first."); return; }
    if(Date.now() > OTP_EXPIRES){ setError('otpError',"OTP expired. Please resend."); return; }
    if(code !== OTP_VALUE){ setError('otpError',"Incorrect code. Try again."); return; }
    setError('otpError',"");
    setSession(OTP_EMAIL);
    hide('authGate'); show('app'); loadMenu();
  });
}

initAuth();
</script>
</body>
</html>
